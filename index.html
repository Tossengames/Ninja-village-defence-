<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stealth Game</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Level Selection Specific Styles */
        .level-scroll-box {
            max-height: 300px;
            overflow-y: auto;
            background: #222;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #444;
            padding: 5px;
        }

        .level-item {
            padding: 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            background: #2a2a2a;
            margin: 5px;
            border-radius: 5px;
        }

        .level-item:hover {
            background: #444;
            color: #ffcc00;
            transform: translateX(5px);
        }

        .level-item:active {
            transform: scale(0.98);
        }

        .story-text {
            font-style: italic;
            color: #bbb;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .rules-box {
            background: #222;
            padding: 15px;
            border-left: 4px solid #ffcc00;
            text-align: left;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .menu-box {
            max-height: 85vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <canvas id="game"></canvas>
    
    <!-- Mission Log (Top Left) -->
    <div id="missionLog" class="hidden"></div>
    
    <!-- UI Controls (Top Right) -->
    <div id="ui-controls" class="hidden">
        <button id="mapToggle" onclick="toggleMinimap()">Toggle Map</button>
    </div>
    
    <!-- Status Circle -->
    <div id="playerStatus" class="status-circle stealth hidden">
        <div class="status-emoji">ü•∑</div>
        <div class="status-glow"></div>
    </div>
    
    <!-- Toolbar -->
    <div id="toolbar" class="hidden">
        <div class="tool-btn" id="btnMove" onclick="setMode('move')">
            <span>üë£</span> Move
        </div>
        <div class="tool-btn" id="btnAttack" onclick="setMode('attack')">
            <span>‚öîÔ∏è</span> Attack
        </div>
        <div class="tool-btn" id="btnTrap" onclick="setMode('trap')">
            <span>‚ö†Ô∏è</span> Trap
            <div class="tool-count" id="trapCount">0</div>
        </div>
        <div class="tool-btn" id="btnRice" onclick="setMode('rice')">
            <span>üçö</span> Rice
            <div class="tool-count" id="riceCount">0</div>
        </div>
        <div class="tool-btn" id="btnBomb" onclick="setMode('bomb')">
            <span>üí£</span> Bomb
            <div class="tool-count" id="bombCount">0</div>
        </div>
        <div class="tool-btn" id="btnGas" onclick="setMode('gas')">
            <span>üí®</span> Gas
            <div class="tool-count" id="gasCount">0</div>
        </div>
        <div class="tool-btn" onclick="playerWait()">
            <span>‚è≥</span> Wait
        </div>
    </div>
    
    <!-- SCREEN 1: MAIN MENU -->
    <div id="mainMenu" class="overlay-screen">
        <div class="menu-box">
            <h1>STEALTH GAME</h1>
            
            <!-- New Level Selection Button -->
            <div class="menu-item">
                <button class="menu-action-btn" onclick="showLevelSelection()" style="width: 100%; margin-bottom: 20px;">
                    SELECT LEVEL
                </button>
            </div>
            
            <div class="menu-item">
                <label>Map Size:</label>
                <div class="number-selector">
                    <button class="num-btn" onclick="changeMapSize(-1)">‚óÄ</button>
                    <span id="mapSizeValue" class="num-value">12</span>
                    <button class="num-btn" onclick="changeMapSize(1)">‚ñ∂</button>
                </div>
            </div>
            
            <div class="menu-item">
                <label>Guard Count:</label>
                <div class="number-selector">
                    <button class="num-btn" onclick="changeGuardCount(-1)">‚óÄ</button>
                    <span id="guardCountValue" class="num-value">5</span>
                    <button class="num-btn" onclick="changeGuardCount(1)">‚ñ∂</button>
                </div>
            </div>
            
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="showTutorial()">HOW TO PLAY</button>
                <button class="start-btn" onclick="showItemSelection()">NEXT ‚Üí</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 2: ITEM SELECTION -->
    <div id="itemSelection" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>SELECT YOUR ITEMS</h1>
            <div class="selection-stats">
                Selected: <span id="totalItems">0</span>/5 items, 
                <span id="totalTypes">0</span>/3 types
            </div>
            
            <!-- Selected Items Preview -->
            <div class="selected-preview" id="selectedPreview">
                <div class="empty-preview">Click items below to add them to your inventory</div>
            </div>
            
            <!-- Item Grid -->
            <div class="item-grid">
                <!-- Row 1 -->
                <div class="item-btn" data-type="trap" onclick="toggleItem('trap')">
                    <div class="item-icon">‚ö†Ô∏è</div>
                    <div class="item-name">Trap</div>
                    <div class="item-count" id="trapSelCount">0</div>
                </div>
                <div class="item-btn" data-type="rice" onclick="toggleItem('rice')">
                    <div class="item-icon">üçö</div>
                    <div class="item-name">Rice</div>
                    <div class="item-count" id="riceSelCount">0</div>
                </div>
                <div class="item-btn" data-type="bomb" onclick="toggleItem('bomb')">
                    <div class="item-icon">üí£</div>
                    <div class="item-name">Bomb</div>
                    <div class="item-count" id="bombSelCount">0</div>
                </div>
                <div class="item-btn" data-type="gas" onclick="toggleItem('gas')">
                    <div class="item-icon">üí®</div>
                    <div class="item-name">Gas</div>
                    <div class="item-count" id="gasSelCount">0</div>
                </div>
                
                <!-- Row 2 -->
                <div class="item-btn" data-type="health" onclick="toggleItem('health')">
                    <div class="item-icon">‚ù§Ô∏è</div>
                    <div class="item-name">Heal</div>
                    <div class="item-count" id="healthSelCount">0</div>
                </div>
                <div class="item-btn" data-type="coin" onclick="toggleItem('coin')">
                    <div class="item-icon">üí∞</div>
                    <div class="item-name">Coin</div>
                    <div class="item-count" id="coinSelCount">0</div>
                </div>
                <div class="item-btn" data-type="sight" onclick="toggleItem('sight')">
                    <div class="item-icon">üëÅÔ∏è</div>
                    <div class="item-name">Sight</div>
                    <div class="item-count" id="sightSelCount">0</div>
                </div>
                <div class="item-btn" data-type="mark" onclick="toggleItem('mark')">
                    <div class="item-icon">üéØ</div>
                    <div class="item-name">Mark</div>
                    <div class="item-count" id="markSelCount">0</div>
                </div>
            </div>
            
            <div class="menu-actions">
                <button class="start-btn" onclick="startGame()" id="startGameBtn">START MISSION</button>
                <button class="menu-action-btn" onclick="backToMainMenu()">‚Üê BACK</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 3: TUTORIAL -->
    <div id="tutorialScreen" class="overlay-screen hidden">
        <div class="tutorial-box">
            <h1>HOW TO PLAY</h1>
            
            <div class="tutorial-content">
                <div class="tutorial-section">
                    <h2>üéÆ CONTROLS</h2>
                    <p>‚Ä¢ <strong>Click/Tap</strong> on highlighted tiles to move, attack, or use items</p>
                    <p>‚Ä¢ <strong>Drag</strong> to pan the camera around the map</p>
                    <p>‚Ä¢ <strong>Pinch/Pull</strong> to zoom in and out</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>üïµÔ∏è STEALTH MECHANICS</h2>
                    <p>‚Ä¢ Move up to <strong>3 tiles</strong> per turn</p>
                    <p>‚Ä¢ Hide in <strong>shadow tiles</strong> to become invisible to enemies</p>
                    <p>‚Ä¢ Enemies have <strong>60¬∞ cone vision</strong> - stay out of their line of sight</p>
                    <p>‚Ä¢ <strong>Stealth kills</strong> are instant if enemy can't see you</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>‚öîÔ∏è COMBAT</h2>
                    <p>‚Ä¢ <strong>Normal attacks</strong> trigger combat if enemy can see you</p>
                    <p>‚Ä¢ <strong>Stealth kills</strong> don't trigger combat (instant kill)</p>
                    <p>‚Ä¢ <strong>Sleeping enemies</strong> can be instantly killed</p>
                    <p>‚Ä¢ When spotted, enemies will chase you for several turns</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>üéØ ITEMS</h2>
                    <p>‚Ä¢ <strong>‚ö†Ô∏è Trap</strong>: Instantly kills enemies that step on it</p>
                    <p>‚Ä¢ <strong>üçö Rice</strong>: Enemies will eat it and die after a few turns</p>
                    <p>‚Ä¢ <strong>üí£ Bomb</strong>: Explodes after 3 turns, damages nearby enemies</p>
                    <p>‚Ä¢ <strong>üí® Gas</strong>: Puts enemies to sleep for several turns</p>
                    <p>‚Ä¢ <strong>‚ù§Ô∏è Heal</strong>: Restores 3 HP (if implemented)</p>
                    <p>‚Ä¢ <strong>üí∞ Coin</strong>: Bonus points if collected (if implemented)</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>üèÜ SCORING</h2>
                    <p>‚Ä¢ <strong>Stealth kills</strong> give bonus points</p>
                    <p>‚Ä¢ <strong>Time bonus</strong>: Faster completion = more points</p>
                    <p>‚Ä¢ <strong>Penalty</strong>: Getting spotted reduces score</p>
                    <p>‚Ä¢ <strong>Ranks</strong>: Grand Master, Master Ninja, Assassin, Shinobi, Ronin, Thug</p>
                </div>
            </div>
            
            <button class="back-btn" onclick="hideTutorial()">BACK TO MENU</button>
        </div>
    </div>
    
    <!-- SCREEN 4: LEVEL SELECTION -->
    <div id="levelSelection" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>SELECT MISSION</h1>
            <div id="level-list" class="level-scroll-box"></div>
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="backToMainMenu()">‚Üê BACK</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 5: LEVEL INFO -->
    <div id="levelInfo" class="overlay-screen hidden">
        <div class="menu-box">
            <h2 id="info-name">Level Name</h2>
            <p id="info-story" class="story-text"></p>
            <div class="rules-box">
                <strong>Objectives:</strong>
                <p id="info-rules" style="margin: 5px 0 0 0;"></p>
            </div>
            <div class="menu-actions">
                <button class="start-btn" onclick="startLevel()">START LEVEL</button>
                <button class="menu-action-btn" onclick="backToLevelSelection()">‚Üê BACK</button>
            </div>
        </div>
    </div>
    
    <!-- Victory Screen -->
    <div id="resultScreen" class="overlay-screen hidden">
        <div class="result-scroll">
            <h1>MISSION COMPLETE</h1>
            <div class="rank-text" id="rankLabel">RANK</div>
            <div id="statsTable"></div>
            <button class="reload-btn" onclick="window.location.reload()">NEW MISSION</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="overlay-screen hidden">
        <div class="result-scroll">
            <h1>MISSION FAILED</h1>
            <div class="fail-text">You have been defeated.<br>Better luck next time!</div>
            <button class="reload-btn" onclick="window.location.reload()">TRY AGAIN</button>
        </div>
    </div>
    
    <!-- OLD MENU (Hidden - for backward compatibility) -->
    <div id="menu" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>STEALTH GAME</h1>
            <div class="menu-item">
                <label>Map Size:</label>
                <input type="number" id="mapSize" min="8" max="20" value="12">
            </div>
            <div class="menu-item">
                <label>Guard Count:</label>
                <input type="number" id="guardCount" min="1" max="15" value="5">
            </div>
            <button class="start-btn" onclick="initGame()">START MISSION</button>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="game.js"></script>
    <script src="core_main.js"></script>
    <script src="core_vfx.js"></script>
    <script src="core_highlight.js"></script>
    <script src="player.js"></script>
    <script src="enemy.js"></script>
    
    <!-- Inline script to connect everything -->
    <script>
        // Global level data storage
        window.selectedLevelData = null;
        
        // Menu navigation functions
        function showLevelSelection() {
            if (typeof initMenu === 'function') {
                initMenu();
            }
            hideAllScreens();
            document.getElementById('levelSelection').classList.remove('hidden');
        }
        
        function backToMainMenu() {
            hideAllScreens();
            document.getElementById('mainMenu').classList.remove('hidden');
        }
        
        function backToLevelSelection() {
            hideAllScreens();
            document.getElementById('levelSelection').classList.remove('hidden');
        }
        
        function startLevel() {
            // Go to item selection after choosing level
            hideAllScreens();
            document.getElementById('itemSelection').classList.remove('hidden');
        }
        
        function hideAllScreens() {
            document.querySelectorAll('.overlay-screen').forEach(screen => {
                screen.classList.add('hidden');
            });
        }
        
        // Override the original startGame to handle JSON data
        const originalStartGame = window.startGame;
        window.startGame = function() {
            // Store level data before starting game
            if (window.currentMapData) {
                window.selectedLevelData = window.currentMapData;
            }
            
            // Call original startGame
            if (originalStartGame) {
                originalStartGame();
            }
        };
        
        // Initialize on load
        window.addEventListener('load', function() {
            if (typeof initMenu === 'function') {
                initMenu();
            }
            // Show main menu
            hideAllScreens();
            document.getElementById('mainMenu').classList.remove('hidden');
        });
    </script>
</body>
</html>