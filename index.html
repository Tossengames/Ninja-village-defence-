<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stealth Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <canvas id="game"></canvas>
    
    <!-- Mission Log (Top Left) -->
    <div id="missionLog" class="hidden"></div>
    
    <!-- UI Controls (Top Right) -->
    <div id="ui-controls" class="hidden">
        <button id="mapToggle" onclick="toggleMinimap()">Toggle Map</button>
    </div>
    
    <!-- Status Circle -->
    <div id="playerStatus" class="status-circle stealth hidden">
        <div class="status-emoji">ü•∑</div>
        <div class="status-glow"></div>
    </div>
    
    <!-- Toolbar -->
    <div id="toolbar" class="hidden">
        <div class="tool-btn" id="btnMove" onclick="setMode('move')">
            <span>üë£</span> Move
        </div>
        <div class="tool-btn" id="btnAttack" onclick="setMode('attack')">
            <span>‚öîÔ∏è</span> Attack
        </div>
        <div class="tool-btn" id="btnTrap" onclick="setMode('trap')">
            <span>‚ö†Ô∏è</span> Trap
            <div class="tool-count" id="trapCount">0</div>
        </div>
        <div class="tool-btn" id="btnRice" onclick="setMode('rice')">
            <span>üçö</span> Rice
            <div class="tool-count" id="riceCount">0</div>
        </div>
        <div class="tool-btn" id="btnBomb" onclick="setMode('bomb')">
            <span>üí£</span> Bomb
            <div class="tool-count" id="bombCount">0</div>
        </div>
        <div class="tool-btn" id="btnGas" onclick="setMode('gas')">
            <span>üí®</span> Gas
            <div class="tool-count" id="gasCount">0</div>
        </div>
        <div class="tool-btn" onclick="playerWait()">
            <span>‚è≥</span> Wait
        </div>
    </div>
    
    <!-- SCREEN 1: MAIN MENU -->
    <div id="mainMenu" class="overlay-screen">
        <div class="menu-box">
            <h1>STEALTH GAME</h1>
            
            <div class="menu-item">
                <label>Map Size:</label>
                <div class="number-selector">
                    <button class="num-btn" onclick="changeMapSize(-1)">‚óÄ</button>
                    <span id="mapSizeValue" class="num-value">12</span>
                    <button class="num-btn" onclick="changeMapSize(1)">‚ñ∂</button>
                </div>
            </div>
            
            <div class="menu-item">
                <label>Guard Count:</label>
                <div class="number-selector">
                    <button class="num-btn" onclick="changeGuardCount(-1)">‚óÄ</button>
                    <span id="guardCountValue" class="num-value">5</span>
                    <button class="num-btn" onclick="changeGuardCount(1)">‚ñ∂</button>
                </div>
            </div>
            
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="openMapSelection()">üéØ SELECT MAP</button> <!-- NEW BUTTON -->
                <button class="menu-action-btn" id="customMissionsBtn" onclick="showCustomMissions()">CUSTOM MISSIONS</button>
                <button class="menu-action-btn" id="editorBtn" onclick="openMapEditorScreen()">MAP EDITOR</button>
                <button class="menu-action-btn" onclick="showTutorial()">HOW TO PLAY</button>
                <button class="start-btn" onclick="showItemSelection()">PLAY RANDOM ‚Üí</button>
            </div>
        </div>
    </div>
    
    <!-- NEW SCREEN: MAP SELECTION -->
    <div id="mapSelectionScreen" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>SELECT MAP</h1>
            <div id="mapListContainer" class="selected-preview" style="max-height: 300px;">
                <div class="empty-preview">Loading maps...</div>
            </div>
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="backToMainMenu()">‚Üê BACK TO MAIN MENU</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 2: ITEM SELECTION -->
    <div id="itemSelection" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>SELECT YOUR ITEMS</h1>
            <div class="selection-stats">
                Selected: <span id="totalItems">0</span>/5 items, 
                <span id="totalTypes">0</span>/3 types
            </div>
            
            <!-- Selected Items Preview -->
            <div class="selected-preview" id="selectedPreview">
                <div class="empty-preview">Click items below to add them to your inventory</div>
            </div>
            
            <!-- Item Grid -->
            <div class="item-grid">
                <!-- Row 1 -->
                <div class="item-btn" data-type="trap" onclick="toggleItem('trap')">
                    <div class="item-icon">‚ö†Ô∏è</div>
                    <div class="item-name">Trap</div>
                    <div class="item-count" id="trapSelCount">0</div>
                </div>
                <div class="item-btn" data-type="rice" onclick="toggleItem('rice')">
                    <div class="item-icon">üçö</div>
                    <div class="item-name">Rice</div>
                    <div class="item-count" id="riceSelCount">0</div>
                </div>
                <div class="item-btn" data-type="bomb" onclick="toggleItem('bomb')">
                    <div class="item-icon">üí£</div>
                    <div class="item-name">Bomb</div>
                    <div class="item-count" id="bombSelCount">0</div>
                </div>
                <div class="item-btn" data-type="gas" onclick="toggleItem('gas')">
                    <div class="item-icon">üí®</div>
                    <div class="item-name">Gas</div>
                    <div class="item-count" id="gasSelCount">0</div>
                </div>
                
                <!-- Row 2 -->
                <div class="item-btn" data-type="health" onclick="toggleItem('health')">
                    <div class="item-icon">‚ù§Ô∏è</div>
                    <div class="item-name">Heal</div>
                    <div class="item-count" id="healthSelCount">0</div>
                </div>
                <div class="item-btn" data-type="coin" onclick="toggleItem('coin')">
                    <div class="item-icon">üí∞</div>
                    <div class="item-name">Coin</div>
                    <div class="item-count" id="coinSelCount">0</div>
                </div>
                <div class="item-btn" data-type="sight" onclick="toggleItem('sight')">
                    <div class="item-icon">üëÅÔ∏è</div>
                    <div class="item-name">Sight</div>
                    <div class="item-count" id="sightSelCount">0</div>
                </div>
                <div class="item-btn" data-type="mark" onclick="toggleItem('mark')">
                    <div class="item-icon">üéØ</div>
                    <div class="item-name">Mark</div>
                    <div class="item-count" id="markSelCount">0</div>
                </div>
            </div>
            
            <div class="menu-actions">
                <button class="start-btn" onclick="startGame()" id="startGameBtn">START MISSION</button>
                <button class="menu-action-btn" onclick="backToMapSelection()">‚Üê BACK TO MAPS</button> <!-- UPDATED -->
            </div>
        </div>
    </div>
    
    <!-- SCREEN 3: TUTORIAL -->
    <div id="tutorialScreen" class="overlay-screen hidden">
        <div class="tutorial-box">
            <h1>HOW TO PLAY</h1>
            
            <div class="tutorial-content">
                <div class="tutorial-section">
                    <h2>üéÆ CONTROLS</h2>
                    <p>‚Ä¢ <strong>Click/Tap</strong> on highlighted tiles to move, attack, or use items</p>
                    <p>‚Ä¢ <strong>Drag</strong> to pan the camera around the map</p>
                    <p>‚Ä¢ <strong>Pinch/Pull</strong> to zoom in and out</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>üïµÔ∏è STEALTH MECHANICS</h2>
                    <p>‚Ä¢ Move up to <strong>3 tiles</strong> per turn</p>
                    <p>‚Ä¢ Hide in <strong>shadow tiles</strong> to become invisible to enemies</p>
                    <p>‚Ä¢ Enemies have <strong>60¬∞ cone vision</strong> - stay out of their line of sight</p>
                    <p>‚Ä¢ <strong>Stealth kills</strong> are instant if enemy can't see you</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>‚öîÔ∏è COMBAT</h2>
                    <p>‚Ä¢ <strong>Normal attacks</strong> trigger combat if enemy can see you</p>
                    <p>‚Ä¢ <strong>Stealth kills</strong> don't trigger combat (instant kill)</p>
                    <p>‚Ä¢ <strong>Sleeping enemies</strong> can be instantly killed</p>
                    <p>‚Ä¢ When spotted, enemies will chase you for several turns</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>üéØ ITEMS</h2>
                    <p>‚Ä¢ <strong>‚ö†Ô∏è Trap</strong>: Instantly kills enemies that step on it</p>
                    <p>‚Ä¢ <strong>üçö Rice</strong>: Enemies will eat it and die after a few turns</p>
                    <p>‚Ä¢ <strong>üí£ Bomb</strong>: Explodes after 3 turns, damages nearby enemies</p>
                    <p>‚Ä¢ <strong>üí® Gas</strong>: Puts enemies to sleep for several turns</p>
                    <p>‚Ä¢ <strong>‚ù§Ô∏è Heal</strong>: Restores 3 HP (if implemented)</p>
                    <p>‚Ä¢ <strong>üí∞ Coin</strong>: Bonus points if collected (if implemented)</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>üèÜ SCORING</h2>
                    <p>‚Ä¢ <strong>Stealth kills</strong> give bonus points</p>
                    <p>‚Ä¢ <strong>Time bonus</strong>: Faster completion = more points</p>
                    <p>‚Ä¢ <strong>Penalty</strong>: Getting spotted reduces score</p>
                    <p>‚Ä¢ <strong>Ranks</strong>: Grand Master, Master Ninja, Assassin, Shinobi, Ronin, Thug</p>
                </div>
            </div>
            
            <button class="back-btn" onclick="hideTutorial()">BACK TO MENU</button>
        </div>
    </div>
    
    <!-- SCREEN 4: CUSTOM MISSIONS -->
    <div id="customMissionsScreen" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>CUSTOM MISSIONS</h1>
            <div id="missionList" class="mission-list">
                <!-- Missions will be loaded here -->
                <div class="empty-preview">Loading missions...</div>
            </div>
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="backToMainMenu()">‚Üê BACK TO MAIN MENU</button>
                <button class="menu-action-btn" onclick="showMapEditor()">CREATE NEW MISSION</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 5: MISSION BRIEFING -->
    <div id="missionBriefingScreen" class="overlay-screen hidden">
        <div class="menu-box">
            <h1 id="missionName">MISSION BRIEFING</h1>
            <div class="mission-story" id="missionStory">
                Mission story will appear here...
            </div>
            <div class="mission-goal" id="missionGoal">
                <strong>Objective:</strong> Reach the exit
            </div>
            <div class="mission-rules" id="missionRules"></div>
            <div class="menu-actions">
                <button class="start-btn" id="startMissionBtn">BEGIN MISSION</button>
                <button class="menu-action-btn" onclick="backToMainMenu()">‚Üê BACK TO MENU</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 6: MAP EDITOR -->
    <div id="mapEditorScreen" class="overlay-screen hidden">
        <div class="editor-container">
            <!-- Left Panel - Tile Palette -->
            <div class="editor-panel editor-left">
                <div class="editor-title">TILE PALETTE</div>
                <div id="tilePalette" class="tile-palette"></div>
                
                <div class="editor-title" style="margin-top: 20px;">TOOLS</div>
                <div class="editor-tools">
                    <div class="tool-btn-small active" id="toolBrush" onclick="setEditorTool('brush')">
                        <div>üñåÔ∏è</div>
                        <div>Brush</div>
                    </div>
                    <div class="tool-btn-small" id="toolFill" onclick="setEditorTool('fill')">
                        <div>üé®</div>
                        <div>Fill</div>
                    </div>
                    <div class="tool-btn-small" id="toolEraser" onclick="setEditorTool('eraser')">
                        <div>üßπ</div>
                        <div>Eraser</div>
                    </div>
                    <div class="tool-btn-small" onclick="clearMap()">
                        <div>üóëÔ∏è</div>
                        <div>Clear</div>
                    </div>
                    <div class="tool-btn-small" onclick="randomizeWalls()">
                        <div>üé≤</div>
                        <div>Random</div>
                    </div>
                    <div class="tool-btn-small" onclick="addBorderWalls()">
                        <div>üî≤</div>
                        <div>Border</div>
                    </div>
                </div>
                
                <div class="map-size-controls">
                    <div class="size-input">
                        <label>Width (8-20):</label>
                        <input type="number" id="mapWidthInput" min="8" max="20" value="12">
                    </div>
                    <div class="size-input">
                        <label>Height (8-20):</label>
                        <input type="number" id="mapHeightInput" min="8" max="20" value="12">
                    </div>
                </div>
                <button class="editor-action-btn" onclick="resizeMap()">RESIZE MAP</button>
            </div>
            
            <!-- Center Panel - Drawing Canvas -->
            <div class="editor-center">
                <div class="editor-canvas-container">
                    <canvas id="editorCanvas"></canvas>
                    <div class="grid-overlay" id="gridOverlay"></div>
                </div>
                <div class="validation-message" id="validationMessage"></div>
            </div>
            
            <!-- Right Panel - Mission Info -->
            <div class="editor-panel editor-right">
                <div class="editor-title">MISSION INFO</div>
                <div class="mission-info-form">
                    <div class="form-group">
                        <label>Mission Name:</label>
                        <input type="text" id="missionNameInput" value="New Mission" maxlength="30">
                    </div>
                    
                    <div class="form-group">
                        <label>Mission Story:</label>
                        <textarea id="missionStoryInput" placeholder="Enter mission briefing..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Goal Type:</label>
                        <select id="missionGoalSelect">
                            <option value="escape">Escape</option>
                            <option value="kill_all">Kill All Enemies</option>
                            <option value="steal">Steal Scroll</option>
                            <option value="pacifist">Pacifist (No Kills)</option>
                            <option value="time_trial">Time Trial</option>
                            <option value="collect_all_coins">Collect All Coins</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="timeLimitGroup" style="display: none;">
                        <label>Time Limit (turns):</label>
                        <input type="number" id="timeLimitInput" min="10" max="100" value="20">
                    </div>
                    
                    <div class="editor-title" style="margin-top: 20px;">RULES</div>
                    <div class="rules-checklist" id="rulesChecklist">
                        <label class="checkbox-item">
                            <input type="checkbox" value="no_kills"> No Kills Allowed
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="no_items"> No Items Allowed
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="no_alert"> Don't Get Spotted
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="all_coins"> Collect All Coins
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="time_limit"> Time Limit
                        </label>
                    </div>
                    
                    <div class="editor-title" style="margin-top: 20px;">EXPORT</div>
                    <textarea id="jsonOutput" class="json-preview" readonly placeholder="JSON will appear here..."></textarea>
                    
                    <div class="editor-actions">
                        <button class="editor-action-btn" onclick="saveToLocalStorage()">üíæ SAVE DRAFT</button>
                        <button class="editor-action-btn" onclick="loadFromLocalStorage()">üìÇ LOAD DRAFT</button>
                        <button class="editor-action-btn primary" onclick="exportMissionJSON()">üì§ EXPORT JSON</button>
                        <button class="editor-action-btn" onclick="importMissionJSON()">üì• IMPORT JSON</button>
                        <button class="editor-action-btn" onclick="testMission()">‚ñ∂Ô∏è TEST MISSION</button>
                        <button class="editor-action-btn" onclick="backToMainMenu()">‚Üê BACK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 7: PAUSE MENU -->
    <div id="pauseScreen" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>MISSION PAUSED</h1>
            <div id="goalTracker"></div>
            <div class="menu-actions">
                <button class="start-btn" onclick="resumeGame()">RESUME MISSION</button>
                <button class="menu-action-btn" onclick="backToMainMenu()">QUIT TO MENU</button>
            </div>
        </div>
    </div>
    
    <!-- Victory Screen -->
    <div id="resultScreen" class="overlay-screen hidden">
        <div class="result-scroll">
            <h1>MISSION COMPLETE</h1>
            <div class="rank-text" id="rankLabel">RANK</div>
            <div id="statsTable"></div>
            <button class="reload-btn" onclick="window.location.reload()">NEW MISSION</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="overlay-screen hidden">
        <div class="result-scroll">
            <h1>MISSION FAILED</h1>
            <div class="fail-text">You have been defeated.<br>Better luck next time!</div>
            <button class="reload-btn" onclick="window.location.reload()">TRY AGAIN</button>
        </div>
    </div>
    
    <!-- OLD MENU (Hidden - for backward compatibility) -->
    <div id="menu" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>STEALTH GAME</h1>
            <div class="menu-item">
                <label>Map Size:</label>
                <input type="number" id="mapSize" min="8" max="20" value="12">
            </div>
            <div class="menu-item">
                <label>Guard Count:</label>
                <input type="number" id="guardCount" min="1" max="15" value="5">
            </div>
            <button class="start-btn" onclick="initGame()">START MISSION</button>
        </div>
    </div>
    
    <!-- Main Game Scripts -->
    <script src="core_main.js"></script>
    <script src="core_vfx.js"></script>
    <script src="core_highlight.js"></script>
    <script src="player.js"></script>
    <script src="enemy.js"></script>
    
    <!-- Map Editor Script -->
    <script src="map_editor.js"></script>
    
    <!-- Mission Manager Script -->
    <script src="mission_manager.js"></script>
    
    <!-- Campaign System (Map Selection) -->
    <script src="campaign.js"></script>
    
    <!-- Inline script to ensure everything loads properly -->
    <script>
        // Quick debug check
        console.log("HTML loaded, checking functions...");
        
        // Check if menu functions exist
        window.addEventListener('load', function() {
            console.log("Page fully loaded");
            console.log("changeMapSize function:", typeof changeMapSize);
            console.log("showItemSelection function:", typeof showItemSelection);
            console.log("startGame function:", typeof startGame);
            console.log("showMapEditor function:", typeof showMapEditor);
            console.log("showCustomMissions function:", typeof showCustomMissions);
            
            // Initialize menu on load
            if (typeof initMenu === 'function') {
                initMenu();
            }
            
            // Add small button styles for mission manager
            if (!document.querySelector('style#mission-manager-styles')) {
                const style = document.createElement('style');
                style.id = 'mission-manager-styles';
                style.textContent = `
                    .small-btn {
                        background: #333;
                        border: 1px solid #444;
                        color: #aaa;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 10px;
                        cursor: pointer;
                        transition: all 0.2s;
                        white-space: nowrap;
                    }
                    .small-btn:hover {
                        background: #3a3a3a;
                        color: #ccc;
                        border-color: #666;
                    }
                    .mission-item .small-btn {
                        opacity: 0;
                        transition: opacity 0.2s;
                    }
                    .mission-item:hover .small-btn {
                        opacity: 1;
                    }
                    .mission-rules {
                        background: rgba(0, 0, 0, 0.3);
                        padding: 10px;
                        border-radius: 8px;
                        margin: 10px 0;
                        font-size: 12px;
                        text-align: left;
                    }
                    .mission-rules ul {
                        margin: 5px 0;
                        padding-left: 20px;
                    }
                    .mission-rules li {
                        margin-bottom: 3px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Set up file input handler for mission imports
            document.addEventListener('click', function(e) {
                if (e.target && e.target.matches('.small-btn')) {
                    const missionId = e.target.closest('.mission-item')?.dataset.missionId;
                    if (missionId) {
                        if (e.target.textContent.includes('Play')) {
                            e.stopPropagation();
                            playMission(missionId);
                        } else if (e.target.textContent.includes('Edit')) {
                            e.stopPropagation();
                            editMission(missionId);
                        } else if (e.target.textContent.includes('Delete')) {
                            e.stopPropagation();
                            deleteMissionUI(missionId);
                        } else if (e.target.textContent.includes('Export')) {
                            e.stopPropagation();
                            exportMission(missionId);
                        }
                    }
                }
            });
            
            // File import handler
            document.addEventListener('change', function(e) {
                if (e.target && e.target.id === 'missionFileInput' && e.target.files[0]) {
                    handleMissionFileUpload(e);
                }
            });
            
            // Helper functions for mission manager UI
            function playMission(missionId) {
                const mission = getMissionById(missionId);
                if (!mission) {
                    alert("Mission not found");
                    return;
                }
                
                if (typeof showMissionBriefing === 'function') {
                    showMissionBriefing(mission);
                } else {
                    alert("Game functions not available. Please reload the page.");
                }
            }
            
            function editMission(missionId) {
                const mission = getMissionById(missionId);
                if (!mission) {
                    alert("Mission not found");
                    return;
                }
                
                if (typeof initMapEditor === 'function') {
                    initMapEditor();
                    setTimeout(() => {
                        if (typeof loadMissionData === 'function') {
                            loadMissionData(mission);
                        }
                    }, 100);
                } else {
                    alert("Editor not available. Please reload the page.");
                }
            }
            
            function deleteMissionUI(missionId) {
                const mission = getMissionById(missionId);
                if (!mission) return;
                
                if (confirm(`Delete mission "${mission.name}"? This cannot be undone.`)) {
                    if (deleteCustomMission(missionId)) {
                        loadMissionListUI();
                        alert("Mission deleted");
                    } else {
                        alert("Error deleting mission");
                    }
                }
            }
            
            function exportMission(missionId) {
                const mission = getMissionById(missionId);
                if (!mission) {
                    alert("Mission not found");
                    return;
                }
                
                const jsonString = JSON.stringify(mission, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = mission.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
            }
            
            function handleMissionFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.endsWith('.json')) {
                    alert("Please select a JSON file");
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const missionData = JSON.parse(e.target.result);
                        
                        // Validate mission data
                        if (!missionData.name || !missionData.width || !missionData.height || !missionData.tiles) {
                            alert("Invalid mission file format");
                            event.target.value = '';
                            return;
                        }
                        
                        // Add unique ID and timestamp
                        missionData.id = 'mission_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        missionData.createdAt = new Date().toISOString();
                        missionData.version = "1.0";
                        
                        // Add to missions
                        if (typeof customMissions !== 'undefined') {
                            customMissions.push(missionData);
                            if (typeof saveCustomMissions === 'function') {
                                saveCustomMissions();
                            }
                        } else {
                            // Fallback to localStorage
                            const savedMissions = JSON.parse(localStorage.getItem('stealthGame_customMissions') || '[]');
                            savedMissions.push(missionData);
                            localStorage.setItem('stealthGame_customMissions', JSON.stringify(savedMissions));
                        }
                        
                        alert(`Mission "${missionData.name}" imported successfully!`);
                        if (typeof loadMissionListUI === 'function') {
                            loadMissionListUI();
                        }
                        event.target.value = '';
                        
                    } catch (error) {
                        alert("Error parsing JSON: " + error.message);
                        event.target.value = '';
                    }
                };
                
                reader.onerror = function() {
                    alert("Error reading file");
                    event.target.value = '';
                };
                
                reader.readAsText(file);
            }
            
            // Expose functions to global scope
            window.playMission = playMission;
            window.editMission = editMission;
            window.deleteMissionUI = deleteMissionUI;
            window.exportMission = exportMission;
            window.handleMissionFileUpload = handleMissionFileUpload;
            
            // Simple mission storage functions if mission_manager.js hasn't loaded
            if (typeof getMissionById === 'undefined') {
                window.customMissions = JSON.parse(localStorage.getItem('stealthGame_customMissions') || '[]');
                
                window.getMissionById = function(missionId) {
                    return customMissions.find(m => m.id === missionId);
                };
                
                window.deleteCustomMission = function(missionId) {
                    const index = customMissions.findIndex(m => m.id === missionId);
                    if (index !== -1) {
                        customMissions.splice(index, 1);
                        localStorage.setItem('stealthGame_customMissions', JSON.stringify(customMissions));
                        return true;
                    }
                    return false;
                };
                
                window.saveCustomMissions = function() {
                    localStorage.setItem('stealthGame_customMissions', JSON.stringify(customMissions));
                    return true;
                };
                
                console.log("Using fallback mission storage");
            }
            
            // Enhanced loadMissionList function
            const originalLoadMissionList = window.loadMissionList;
            window.loadMissionList = function() {
                loadMissionListUI();
            };
            
            function loadMissionListUI() {
                const missionList = document.getElementById('missionList');
                if (!missionList) return;
                
                const missions = customMissions || [];
                
                missionList.innerHTML = '';
                
                if (missions.length === 0) {
                    missionList.innerHTML = `
                        <div class="empty-preview">
                            <div style="margin-bottom: 10px;">No custom missions yet!</div>
                            <div style="font-size: 12px; color: #888;">
                                Create your first mission using the Map Editor
                            </div>
                        </div>
                    `;
                    return;
                }
                
                missions.forEach(mission => {
                    const missionDiv = document.createElement('div');
                    missionDiv.className = 'mission-item';
                    missionDiv.dataset.missionId = mission.id;
                    
                    // Truncate long descriptions
                    const shortStory = mission.story 
                        ? (mission.story.length > 80 ? mission.story.substring(0, 77) + '...' : mission.story)
                        : "No description";
                    
                    missionDiv.innerHTML = `
                        <div class="mission-title">${mission.name}</div>
                        <div class="mission-description">${shortStory}</div>
                        <div class="mission-goal">${mission.goal.toUpperCase().replace('_', ' ')} ‚Ä¢ ${mission.width}x${mission.height}</div>
                        <div style="display: flex; gap: 5px; margin-top: 8px;">
                            <button class="small-btn">‚ñ∂Ô∏è Play</button>
                            <button class="small-btn">‚úèÔ∏è Edit</button>
                            <button class="small-btn">üóëÔ∏è Delete</button>
                            <button class="small-btn">üì§ Export</button>
                        </div>
                    `;
                    
                    missionList.appendChild(missionDiv);
                });
                
                // Add file import button
                const importDiv = document.createElement('div');
                importDiv.className = 'mission-item';
                importDiv.style.textAlign = 'center';
                importDiv.style.padding = '20px';
                
                importDiv.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">üìÅ</div>
                    <div class="mission-title">IMPORT MISSION FILE</div>
                    <div class="mission-description">Upload a .json mission file</div>
                    <input type="file" id="missionFileInput" accept=".json" style="display: none;">
                    <button class="small-btn" onclick="document.getElementById('missionFileInput').click()" style="margin-top: 10px;">
                        üì• Choose File
                    </button>
                `;
                
                missionList.appendChild(importDiv);
            }
            
            window.loadMissionListUI = loadMissionListUI;
        });
    </script>
</body>
</html>