<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stealth Game</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Additional styles for mission loader */
        .mission-item {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mission-item:hover {
            background: rgba(40, 40, 40, 0.9);
            border-color: #00d2ff;
        }
        
        .mission-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .mission-description {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }
        
        .mission-goal {
            font-size: 11px;
            color: #ff9900;
            font-weight: bold;
        }
        
        .small-btn {
            background: #333;
            color: #ddd;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .small-btn:hover {
            background: #444;
            border-color: #00d2ff;
        }
        
        .selected-item-preview {
            display: inline-flex;
            align-items: center;
            background: rgba(0, 210, 255, 0.1);
            border: 1px solid #00d2ff;
            border-radius: 20px;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
        }
        
        .remove-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            margin-left: 5px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <canvas id="game"></canvas>
    
    <!-- Mission Log (Top Left) -->
    <div id="missionLog" class="hidden"></div>
    
    <!-- UI Controls (Top Right) -->
    <div id="ui-controls" class="hidden">
        <button id="mapToggle" onclick="toggleMinimap()">Toggle Map</button>
    </div>
    
    <!-- Status Circle -->
    <div id="playerStatus" class="status-circle stealth hidden">
        <div class="status-emoji">ü•∑</div>
        <div class="status-glow"></div>
    </div>
    
    <!-- Toolbar -->
    <div id="toolbar" class="hidden">
        <div class="tool-btn" id="btnMove" onclick="setMode('move')">
            <span>üë£</span> Move
        </div>
        <div class="tool-btn" id="btnAttack" onclick="setMode('attack')">
            <span>‚öîÔ∏è</span> Attack
        </div>
        <div class="tool-btn" id="btnTrap" onclick="setMode('trap')">
            <span>‚ö†Ô∏è</span> Trap
            <div class="tool-count" id="trapCount">0</div>
        </div>
        <div class="tool-btn" id="btnRice" onclick="setMode('rice')">
            <span>üçö</span> Rice
            <div class="tool-count" id="riceCount">0</div>
        </div>
        <div class="tool-btn" id="btnBomb" onclick="setMode('bomb')">
            <span>üí£</span> Bomb
            <div class="tool-count" id="bombCount">0</div>
        </div>
        <div class="tool-btn" id="btnGas" onclick="setMode('gas')">
            <span>üí®</span> Gas
            <div class="tool-count" id="gasCount">0</div>
        </div>
        <div class="tool-btn" onclick="playerWait()">
            <span>‚è≥</span> Wait
        </div>
    </div>
    
    <!-- SCREEN 1: MAIN MENU -->
    <div id="mainMenu" class="overlay-screen">
        <div class="menu-box">
            <h1>STEALTH GAME</h1>
            
            <div class="menu-item">
                <label>Map Size:</label>
                <div class="number-selector">
                    <button class="num-btn" onclick="changeMapSize(-1)">‚óÄ</button>
                    <span id="mapSizeValue" class="num-value">12</span>
                    <button class="num-btn" onclick="changeMapSize(1)">‚ñ∂</button>
                </div>
            </div>
            
            <div class="menu-item">
                <label>Guard Count:</label>
                <div class="number-selector">
                    <button class="num-btn" onclick="changeGuardCount(-1)">‚óÄ</button>
                    <span id="guardCountValue" class="num-value">5</span>
                    <button class="num-btn" onclick="changeGuardCount(1)">‚ñ∂</button>
                </div>
            </div>
            
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="openCustomMissions()">CUSTOM MISSIONS</button>
                <button class="menu-action-btn" onclick="openMapEditor()">MAP EDITOR</button>
                <button class="menu-action-btn" onclick="showTutorial()">HOW TO PLAY</button>
                <button class="start-btn" onclick="showItemSelection()">PLAY RANDOM ‚Üí</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 2: ITEM SELECTION -->
    <div id="itemSelection" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>SELECT YOUR ITEMS</h1>
            <div class="selection-stats">
                Selected: <span id="totalItems">0</span>/5 items, 
                <span id="totalTypes">0</span>/3 types
            </div>
            
            <!-- Selected Items Preview -->
            <div class="selected-preview" id="selectedPreview">
                <div class="empty-preview">Click items below to add them to your inventory</div>
            </div>
            
            <!-- Item Grid -->
            <div class="item-grid">
                <!-- Row 1 -->
                <div class="item-btn" data-type="trap" onclick="toggleItem('trap')">
                    <div class="item-icon">‚ö†Ô∏è</div>
                    <div class="item-name">Trap</div>
                    <div class="item-count" id="trapSelCount">0</div>
                </div>
                <div class="item-btn" data-type="rice" onclick="toggleItem('rice')">
                    <div class="item-icon">üçö</div>
                    <div class="item-name">Rice</div>
                    <div class="item-count" id="riceSelCount">0</div>
                </div>
                <div class="item-btn" data-type="bomb" onclick="toggleItem('bomb')">
                    <div class="item-icon">üí£</div>
                    <div class="item-name">Bomb</div>
                    <div class="item-count" id="bombSelCount">0</div>
                </div>
                <div class="item-btn" data-type="gas" onclick="toggleItem('gas')">
                    <div class="item-icon">üí®</div>
                    <div class="item-name">Gas</div>
                    <div class="item-count" id="gasSelCount">0</div>
                </div>
                
                <!-- Row 2 -->
                <div class="item-btn" data-type="health" onclick="toggleItem('health')">
                    <div class="item-icon">‚ù§Ô∏è</div>
                    <div class="item-name">Heal</div>
                    <div class="item-count" id="healthSelCount">0</div>
                </div>
                <div class="item-btn" data-type="coin" onclick="toggleItem('coin')">
                    <div class="item-icon">üí∞</div>
                    <div class="item-name">Coin</div>
                    <div class="item-count" id="coinSelCount">0</div>
                </div>
                <div class="item-btn" data-type="sight" onclick="toggleItem('sight')">
                    <div class="item-icon">üëÅÔ∏è</div>
                    <div class="item-name">Sight</div>
                    <div class="item-count" id="sightSelCount">0</div>
                </div>
                <div class="item-btn" data-type="mark" onclick="toggleItem('mark')">
                    <div class="item-icon">üéØ</div>
                    <div class="item-name">Mark</div>
                    <div class="item-count" id="markSelCount">0</div>
                </div>
            </div>
            
            <div class="menu-actions">
                <button class="start-btn" onclick="startGame()" id="startGameBtn">START MISSION</button>
                <button class="menu-action-btn" onclick="backToMainMenu()">‚Üê BACK</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 3: TUTORIAL -->
    <div id="tutorialScreen" class="overlay-screen hidden">
        <div class="tutorial-box">
            <h1>HOW TO PLAY</h1>
            
            <div class="tutorial-content">
                <div class="tutorial-section">
                    <h2>üéÆ CONTROLS</h2>
                    <p>‚Ä¢ <strong>Click/Tap</strong> on highlighted tiles to move, attack, or use items</p>
                    <p>‚Ä¢ <strong>Drag</strong> to pan the camera around the map</p>
                    <p>‚Ä¢ <strong>Pinch/Pull</strong> to zoom in and out</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>üïµÔ∏è STEALTH MECHANICS</h2>
                    <p>‚Ä¢ Move up to <strong>3 tiles</strong> per turn</p>
                    <p>‚Ä¢ Hide in <strong>shadow tiles</strong> to become invisible to enemies</p>
                    <p>‚Ä¢ Enemies have <strong>60¬∞ cone vision</strong> - stay out of their line of sight</p>
                    <p>‚Ä¢ <strong>Stealth kills</strong> are instant if enemy can't see you</p>
                </div>
                
                <div class="tutorial-section">
                    <h2>‚öîÔ∏è COMBAT</h2>
                    <p>‚Ä¢ <strong>Normal attacks</strong> trigger combat if enemy can see you</p>
                    <p>‚Ä¢ <strong>Stealth kills</strong> don't trigger combat (instant kill)</p>
                    <p>‚Ä¢ <strong>Sleeping enemies</strong> can be instantly killed</p>
                    <p>‚Ä¢ When spotted, enemies will chase you for several turns</p>
                </div>
            </div>
            
            <button class="back-btn" onclick="hideTutorial()">BACK TO MENU</button>
        </div>
    </div>
    
    <!-- SCREEN 4: CUSTOM MISSIONS -->
    <div id="customMissionsScreen" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>CUSTOM MISSIONS</h1>
            <div id="missionList" class="mission-list">
                <!-- Missions will be loaded here -->
                <div class="empty-preview">Loading missions...</div>
            </div>
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="backToMainMenu()">‚Üê BACK TO MAIN MENU</button>
                <button class="menu-action-btn" onclick="openMapEditor()">CREATE NEW MISSION</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 5: MISSION BRIEFING -->
    <div id="missionBriefingScreen" class="overlay-screen hidden">
        <div class="menu-box">
            <h1 id="missionName">MISSION BRIEFING</h1>
            <div class="mission-story" id="missionStory">
                Mission story will appear here...
            </div>
            <div class="mission-goal" id="missionGoal">
                <strong>Objective:</strong> Reach the exit
            </div>
            <div class="mission-rules" id="missionRules"></div>
            <div class="menu-actions">
                <button class="start-btn" id="startMissionBtn">BEGIN MISSION</button>
                <button class="menu-action-btn" onclick="backToMainMenu()">‚Üê BACK TO MENU</button>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 6: MAP EDITOR -->
    <div id="mapEditorScreen" class="overlay-screen hidden">
        <div class="editor-container">
            <!-- Left Panel - Tile Palette -->
            <div class="editor-panel editor-left">
                <div class="editor-title">TILE PALETTE</div>
                <div id="tilePalette" class="tile-palette"></div>
                
                <div class="editor-title" style="margin-top: 20px;">TOOLS</div>
                <div class="editor-tools">
                    <div class="tool-btn-small active" id="toolBrush" onclick="setEditorTool('brush')">
                        <div>üñåÔ∏è</div>
                        <div>Brush</div>
                    </div>
                    <div class="tool-btn-small" id="toolFill" onclick="setEditorTool('fill')">
                        <div>üé®</div>
                        <div>Fill</div>
                    </div>
                    <div class="tool-btn-small" id="toolEraser" onclick="setEditorTool('eraser')">
                        <div>üßπ</div>
                        <div>Eraser</div>
                    </div>
                    <div class="tool-btn-small" onclick="editorClearMap()">
                        <div>üóëÔ∏è</div>
                        <div>Clear</div>
                    </div>
                    <div class="tool-btn-small" onclick="editorRandomizeWalls()">
                        <div>üé≤</div>
                        <div>Random</div>
                    </div>
                    <div class="tool-btn-small" onclick="editorAddBorderWalls()">
                        <div>üî≤</div>
                        <div>Border</div>
                    </div>
                </div>
                
                <div class="map-size-controls">
                    <div class="size-input">
                        <label>Width (8-20):</label>
                        <input type="number" id="mapWidthInput" min="8" max="20" value="12">
                    </div>
                    <div class="size-input">
                        <label>Height (8-20):</label>
                        <input type="number" id="mapHeightInput" min="8" max="20" value="12">
                    </div>
                </div>
                <button class="editor-action-btn" onclick="editorResizeMap()">RESIZE MAP</button>
            </div>
            
            <!-- Center Panel - Drawing Canvas -->
            <div class="editor-center">
                <div class="editor-canvas-container">
                    <canvas id="editorCanvas"></canvas>
                </div>
                <div class="validation-message" id="validationMessage"></div>
            </div>
            
            <!-- Right Panel - Mission Info -->
            <div class="editor-panel editor-right">
                <div class="editor-title">MISSION INFO</div>
                <div class="mission-info-form">
                    <div class="form-group">
                        <label>Mission Name:</label>
                        <input type="text" id="missionNameInput" value="New Mission" maxlength="30">
                    </div>
                    
                    <div class="form-group">
                        <label>Mission Story:</label>
                        <textarea id="missionStoryInput" placeholder="Enter mission briefing..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Goal Type:</label>
                        <select id="missionGoalSelect">
                            <option value="escape">Escape</option>
                            <option value="kill_all">Kill All Enemies</option>
                            <option value="steal">Steal Scroll</option>
                            <option value="pacifist">Pacifist (No Kills)</option>
                            <option value="time_trial">Time Trial</option>
                            <option value="collect_all_coins">Collect All Coins</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="timeLimitGroup" style="display: none;">
                        <label>Time Limit (turns):</label>
                        <input type="number" id="timeLimitInput" min="10" max="100" value="20">
                    </div>
                    
                    <div class="editor-title" style="margin-top: 20px;">RULES</div>
                    <div class="rules-checklist" id="rulesChecklist">
                        <label class="checkbox-item">
                            <input type="checkbox" value="no_kills"> No Kills Allowed
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="no_items"> No Items Allowed
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="no_alert"> Don't Get Spotted
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="all_coins"> Collect All Coins
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="time_limit"> Time Limit
                        </label>
                    </div>
                    
                    <div class="editor-title" style="margin-top: 20px;">EXPORT</div>
                    <textarea id="jsonOutput" class="json-preview" readonly placeholder="JSON will appear here..."></textarea>
                    
                    <div class="editor-actions">
                        <button class="editor-action-btn" onclick="editorSaveToLocalStorage()">üíæ SAVE DRAFT</button>
                        <button class="editor-action-btn" onclick="editorLoadFromLocalStorage()">üìÇ LOAD DRAFT</button>
                        <button class="editor-action-btn primary" onclick="editorExportMissionJSON()">üì§ EXPORT JSON</button>
                        <button class="editor-action-btn" onclick="editorImportMissionJSON()">üì• IMPORT JSON</button>
                        <button class="editor-action-btn" onclick="editorTestMission()">‚ñ∂Ô∏è TEST MISSION</button>
                        <button class="editor-action-btn" onclick="backToMainMenu()">‚Üê BACK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SCREEN 7: PAUSE MENU -->
    <div id="pauseScreen" class="overlay-screen hidden">
        <div class="menu-box">
            <h1>MISSION PAUSED</h1>
            <div id="goalTracker"></div>
            <div class="menu-actions">
                <button class="start-btn" onclick="resumeGame()">RESUME MISSION</button>
                <button class="menu-action-btn" onclick="backToMainMenu()">QUIT TO MENU</button>
            </div>
        </div>
    </div>
    
    <!-- Victory Screen -->
    <div id="resultScreen" class="overlay-screen hidden">
        <div class="result-scroll">
            <h1>MISSION COMPLETE</h1>
            <div class="rank-text" id="rankLabel">RANK</div>
            <div id="statsTable"></div>
            <button class="reload-btn" onclick="window.location.reload()">NEW MISSION</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="overlay-screen hidden">
        <div class="result-scroll">
            <h1>MISSION FAILED</h1>
            <div class="fail-text">You have been defeated.<br>Better luck next time!</div>
            <button class="reload-btn" onclick="window.location.reload()">TRY AGAIN</button>
        </div>
    </div>
    
    <!-- Main Game Scripts -->
    <script src="core_main.js"></script>
    
    <!-- SIMPLE MISSION LOADER SCRIPT -->
    <script>
    // ============================================
    // SIMPLE MISSION LOADER
    // ============================================
    
    const MAPS_FOLDER = 'maps/';
    let gameMissions = [];
    let customMissions = [];
    
    // Load missions on page load
    window.addEventListener('load', async function() {
        console.log('Loading missions...');
        
        // Load custom missions from localStorage
        try {
            const saved = localStorage.getItem('stealthGame_customMissions');
            if (saved) {
                customMissions = JSON.parse(saved);
                console.log('Loaded', customMissions.length, 'custom missions');
            }
        } catch (e) {
            console.log('No custom missions found');
        }
        
        // Load game missions from maps folder
        await loadGameMissions();
        
        console.log('Total missions:', gameMissions.length + customMissions.length);
        
        // Initialize menu
        if (typeof initMenu === 'function') {
            initMenu();
        }
    });
    
    async function loadGameMissions() {
        gameMissions = [];
        
        // Create a sample mission if none exist
        if (gameMissions.length === 0) {
            const sampleMission = {
                id: 'mission_sample',
                fileName: 'sample.json',
                source: 'game',
                isCustom: false,
                name: "Sample Mission",
                story: "A test mission to verify loading works",
                goal: "escape",
                rules: [],
                timeLimit: 0,
                width: 12,
                height: 12,
                tiles: Array(12).fill().map(() => Array(12).fill(0)),
                playerStart: {x: 1, y: 1},
                exit: {x: 10, y: 10},
                enemies: [
                    {x: 5, y: 5, type: "NORMAL"},
                    {x: 7, y: 7, type: "ARCHER"}
                ],
                items: [
                    {x: 3, y: 3, type: "coin"},
                    {x: 8, y: 8, type: "coin"}
                ],
                difficulty: "medium"
            };
            
            // Add walls around the edge
            for(let i = 0; i < 12; i++) {
                sampleMission.tiles[0][i] = 1;
                sampleMission.tiles[11][i] = 1;
                sampleMission.tiles[i][0] = 1;
                sampleMission.tiles[i][11] = 1;
            }
            
            gameMissions.push(sampleMission);
            console.log('Created sample mission');
        }
    }
    
    function getAllMissions() {
        return [...gameMissions, ...customMissions];
    }
    
    // Display missions in UI
    function displayMissions() {
        const missionList = document.getElementById('missionList');
        if (!missionList) return;
        
        const allMissions = getAllMissions();
        
        if (allMissions.length === 0) {
            missionList.innerHTML = `
                <div class="empty-preview">
                    <div style="margin-bottom: 10px;">üìÅ No missions found!</div>
                    <button onclick="refreshMissions()" style="margin-top: 15px; padding: 8px 16px; background: #333; color: #aaa; border: 1px solid #444; border-radius: 5px; cursor: pointer;">
                        üîÑ Refresh
                    </button>
                </div>
            `;
            return;
        }
        
        missionList.innerHTML = '';
        
        allMissions.forEach(mission => {
            const div = document.createElement('div');
            div.className = 'mission-item';
            div.dataset.missionId = mission.id;
            
            const sourceBadge = mission.isCustom 
                ? '<span style="background: #ff9900; color: #000; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold; margin-left: 5px;">Custom</span>'
                : '<span style="background: #3366cc; color: #fff; padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold; margin-left: 5px;">Game</span>';
            
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div class="mission-title">${mission.name} ${sourceBadge}</div>
                        <div class="mission-description">${mission.story || 'No description'}</div>
                    </div>
                    <div style="background: ${mission.difficulty === 'easy' ? '#33cc33' : mission.difficulty === 'hard' ? '#ff3333' : '#ff9900'}; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">
                        ${mission.difficulty ? mission.difficulty.toUpperCase() : 'MEDIUM'}
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #888;">
                    <div>${mission.goal ? mission.goal.toUpperCase().replace('_', ' ') : 'ESCAPE'}</div>
                    <div>${mission.width}x${mission.height}</div>
                </div>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <button class="small-btn play-btn">‚ñ∂Ô∏è Play</button>
                    ${mission.isCustom ? `
                        <button class="small-btn edit-btn">‚úèÔ∏è Edit</button>
                        <button class="small-btn delete-btn">üóëÔ∏è Delete</button>
                    ` : ''}
                </div>
            `;
            
            // Add event listeners
            div.querySelector('.play-btn').onclick = (e) => {
                e.stopPropagation();
                playMission(mission.id);
            };
            
            if (mission.isCustom) {
                div.querySelector('.edit-btn').onclick = (e) => {
                    e.stopPropagation();
                    editMission(mission.id);
                };
                div.querySelector('.delete-btn').onclick = (e) => {
                    e.stopPropagation();
                    deleteMissionUI(mission.id);
                };
            }
            
            missionList.appendChild(div);
        });
    }
    
    // Play mission
    function playMission(missionId) {
        const mission = getMissionById(missionId);
        if (!mission) {
            alert("Mission not found");
            return;
        }
        
        console.log("Playing mission:", mission.name);
        
        // Use startCustomMission from core_main.js
        if (typeof startCustomMission === 'function') {
            // Create a clean copy
            const missionCopy = JSON.parse(JSON.stringify(mission));
            startCustomMission(missionCopy);
        } else {
            alert("Game not loaded properly. Please refresh the page.");
        }
    }
    
    // Edit mission
    function editMission(missionId) {
        const mission = getMissionById(missionId);
        if (!mission || !mission.isCustom) {
            alert("Cannot edit game missions. Create a copy first.");
            return;
        }
        
        // First open the editor
        openMapEditor();
        
        // Then load the mission (editor needs to be initialized first)
        setTimeout(() => {
            if (typeof loadMissionData === 'function') {
                loadMissionData(mission);
            } else {
                console.log("Editor not ready yet, trying again...");
                setTimeout(() => {
                    if (typeof loadMissionData === 'function') {
                        loadMissionData(mission);
                    }
                }, 500);
            }
        }, 300);
    }
    
    // Delete mission
    function deleteMissionUI(missionId) {
        const mission = getMissionById(missionId);
        if (!mission || !mission.isCustom) {
            alert("Cannot delete game missions");
            return;
        }
        
        if (!confirm(`Delete mission "${mission.name}"? This cannot be undone.`)) {
            return;
        }
        
        const index = customMissions.findIndex(m => m.id === missionId);
        if (index !== -1) {
            customMissions.splice(index, 1);
            localStorage.setItem('stealthGame_customMissions', JSON.stringify(customMissions));
            displayMissions();
            alert("Mission deleted");
        }
    }
    
    // Handle file upload
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.json')) {
            alert("Please select a JSON file");
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const missionData = JSON.parse(e.target.result);
                
                // Validate mission data
                if (!missionData.name || !missionData.width || !missionData.height) {
                    alert("Invalid mission file format");
                    event.target.value = '';
                    return;
                }
                
                // Add unique ID and timestamp
                missionData.id = 'custom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                missionData.createdAt = new Date().toISOString();
                missionData.isCustom = true;
                missionData.fileName = file.name;
                missionData.source = 'custom';
                
                // Add to custom missions
                customMissions.push(missionData);
                
                // Save to localStorage
                localStorage.setItem('stealthGame_customMissions', JSON.stringify(customMissions));
                
                alert(`Mission "${missionData.name}" imported successfully!`);
                displayMissions();
                event.target.value = '';
                
            } catch (error) {
                alert("Error parsing JSON: " + error.message);
                event.target.value = '';
            }
        };
        
        reader.readAsText(file);
    }
    
    // Get mission by ID
    function getMissionById(missionId) {
        return getAllMissions().find(m => m.id === missionId);
    }
    
    // UI Functions
    function openCustomMissions() {
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('customMissionsScreen').classList.remove('hidden');
        displayMissions();
    }
    
    function openMapEditor() {
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('customMissionsScreen').classList.add('hidden');
        document.getElementById('mapEditorScreen').classList.remove('hidden');
        
        // Initialize editor
        if (typeof initMapEditor === 'function') {
            setTimeout(() => {
                initMapEditor();
            }, 100);
        } else {
            console.error("Map editor functions not loaded!");
            alert("Map editor not available. Make sure all scripts are loaded.");
        }
    }
    
    // Make functions globally available
    window.openCustomMissions = openCustomMissions;
    window.openMapEditor = openMapEditor;
    window.playMission = playMission;
    window.editMission = editMission;
    window.deleteMissionUI = deleteMissionUI;
    window.getMissionById = getMissionById;
    window.refreshMissions = async function() {
        await loadGameMissions();
        displayMissions();
    };
    
    // Setup file input
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('missionFileInput');
        if (fileInput) {
            fileInput.addEventListener('change', handleFileUpload);
        }
    });
    
    console.log('Mission Loader ready!');
    </script>
    
    <!-- Map Editor Script (inline to avoid loading issues) -->
    <script>
    // ============================================
    // MAP EDITOR
    // ============================================
    
    // Tile types (MUST MATCH core_main.js)
    const TILE_TYPES = {
        FLOOR: 0,
        WALL: 1,
        HIDE: 2,
        EXIT: 3,
        COIN: 5,
        TRAP: 6,
        RICE: 7,
        BOMB: 8,
        GAS: 9,
        SCROLL: 10,
        MYSTERY_BOX: 11,
        FLOOR2: 21,
        GRASS1: 22,
        WALL2: 23,
        WATER: 24,
        TREE1: 25,
        TREE2: 26,
        BUSH1: 27,
        BUSH2: 28,
        BOX1: 29
    };
    
    // Editor state
    let editorState = {
        selectedTile: TILE_TYPES.WALL,
        mapWidth: 12,
        mapHeight: 12,
        tiles: [],
        playerStart: null,
        exitPos: null,
        enemies: [],
        items: [],
        missionName: "New Mission",
        missionStory: "",
        missionGoal: "escape",
        missionRules: [],
        timeLimit: 20,
        currentTool: 'brush'
    };
    
    // All available tiles
    const ALL_TILES = [
        { id: TILE_TYPES.FLOOR, name: "Floor", color: "#666666" },
        { id: TILE_TYPES.WALL, name: "Wall", color: "#888888" },
        { id: TILE_TYPES.HIDE, name: "Hide", color: "#3333aa" },
        { id: TILE_TYPES.EXIT, name: "Exit", color: "#00ff00" },
        { id: TILE_TYPES.COIN, name: "Coin", color: "#ffd700" },
        { id: TILE_TYPES.TRAP, name: "Trap", color: "#ff6666" },
        { id: TILE_TYPES.RICE, name: "Rice", color: "#ffff66" },
        { id: TILE_TYPES.BOMB, name: "Bomb", color: "#ff3399" },
        { id: TILE_TYPES.GAS, name: "Gas", color: "#9932cc" },
        { id: TILE_TYPES.SCROLL, name: "Scroll", color: "#9932cc" },
        { id: TILE_TYPES.MYSTERY_BOX, name: "Mystery Box", color: "#ff9900" },
        { id: TILE_TYPES.FLOOR2, name: "Floor 2", color: "#777777" },
        { id: TILE_TYPES.GRASS1, name: "Grass", color: "#33aa33" },
        { id: TILE_TYPES.WALL2, name: "Wall 2", color: "#999999" },
        { id: TILE_TYPES.WATER, name: "Water", color: "#3366cc" },
        { id: TILE_TYPES.TREE1, name: "Tree 1", color: "#228822" },
        { id: TILE_TYPES.TREE2, name: "Tree 2", color: "#226622" },
        { id: TILE_TYPES.BUSH1, name: "Bush 1", color: "#33cc33" },
        { id: TILE_TYPES.BUSH2, name: "Bush 2", color: "#44dd44" },
        { id: TILE_TYPES.BOX1, name: "Box", color: "#996633" },
        { id: 'player', name: "Player", color: "#00d2ff", isEntity: true },
        { id: 'enemy_normal', name: "Guard", color: "#ff3333", isEntity: true },
        { id: 'enemy_archer', name: "Archer", color: "#33cc33", isEntity: true },
        { id: 'enemy_spear', name: "Spear", color: "#3366ff", isEntity: true }
    ];
    
    let editorCanvas, editorCtx;
    let tileSize = 40;
    let isDragging = false;
    let lastPos = null;
    
    // Initialize editor
    function initMapEditor() {
        console.log("Initializing map editor...");
        
        // Get canvas
        editorCanvas = document.getElementById('editorCanvas');
        if (!editorCanvas) {
            console.error("Editor canvas not found!");
            return;
        }
        
        editorCtx = editorCanvas.getContext('2d');
        
        // Setup event listeners
        setupEditorEvents();
        
        // Create empty map
        createEmptyMap();
        
        // Populate tile palette
        populateTilePalette();
        
        // Setup form listeners
        setupFormListeners();
        
        // Render initial state
        renderEditor();
        
        console.log("Map editor initialized!");
    }
    
    // Setup editor events
    function setupEditorEvents() {
        if (!editorCanvas) return;
        
        // Mouse events
        editorCanvas.addEventListener('mousedown', handleMouseDown);
        editorCanvas.addEventListener('mousemove', handleMouseMove);
        editorCanvas.addEventListener('mouseup', handleMouseUp);
        
        // Touch events
        editorCanvas.addEventListener('touchstart', handleTouchStart);
        editorCanvas.addEventListener('touchmove', handleTouchMove);
        editorCanvas.addEventListener('touchend', handleTouchEnd);
        
        // Prevent context menu
        editorCanvas.addEventListener('contextmenu', e => e.preventDefault());
        
        // Resize canvas
        updateCanvasSize();
        window.addEventListener('resize', updateCanvasSize);
    }
    
    // Setup form listeners
    function setupFormListeners() {
        // Mission name
        const nameInput = document.getElementById('missionNameInput');
        if (nameInput) {
            nameInput.value = editorState.missionName;
            nameInput.addEventListener('input', function() {
                editorState.missionName = this.value;
            });
        }
        
        // Mission story
        const storyInput = document.getElementById('missionStoryInput');
        if (storyInput) {
            storyInput.value = editorState.missionStory;
            storyInput.addEventListener('input', function() {
                editorState.missionStory = this.value;
            });
        }
        
        // Goal type
        const goalSelect = document.getElementById('missionGoalSelect');
        if (goalSelect) {
            goalSelect.value = editorState.missionGoal;
            goalSelect.addEventListener('change', function() {
                editorState.missionGoal = this.value;
                updateTimeLimitVisibility();
            });
        }
        
        // Time limit
        const timeLimitInput = document.getElementById('timeLimitInput');
        if (timeLimitInput) {
            timeLimitInput.value = editorState.timeLimit;
            timeLimitInput.addEventListener('input', function() {
                editorState.timeLimit = parseInt(this.value) || 20;
            });
        }
        
        // Map size inputs
        const widthInput = document.getElementById('mapWidthInput');
        const heightInput = document.getElementById('mapHeightInput');
        if (widthInput && heightInput) {
            widthInput.value = editorState.mapWidth;
            heightInput.value = editorState.mapHeight;
        }
        
        updateTimeLimitVisibility();
    }
    
    function updateTimeLimitVisibility() {
        const timeLimitGroup = document.getElementById('timeLimitGroup');
        if (timeLimitGroup) {
            timeLimitGroup.style.display = editorState.missionGoal === 'time_trial' ? 'block' : 'none';
        }
    }
    
    // Create empty map
    function createEmptyMap() {
        const width = editorState.mapWidth;
        const height = editorState.mapHeight;
        
        // Create empty grid
        editorState.tiles = Array(height).fill().map(() => Array(width).fill(TILE_TYPES.FLOOR));
        
        // Add border walls
        editorAddBorderWalls();
        
        // Reset entities
        editorState.playerStart = null;
        editorState.exitPos = null;
        editorState.enemies = [];
        editorState.items = [];
        
        updateCanvasSize();
    }
    
    // Add border walls
    function editorAddBorderWalls() {
        const width = editorState.mapWidth;
        const height = editorState.mapHeight;
        
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                if (x === 0 || y === 0 || x === width - 1 || y === height - 1) {
                    editorState.tiles[y][x] = TILE_TYPES.WALL;
                }
            }
        }
    }
    
    // Update canvas size
    function updateCanvasSize() {
        if (!editorCanvas) return;
        
        const container = document.querySelector('.editor-canvas-container');
        if (!container) return;
        
        editorCanvas.width = container.clientWidth;
        editorCanvas.height = container.clientHeight;
        
        const maxTileWidth = Math.floor(editorCanvas.width / editorState.mapWidth);
        const maxTileHeight = Math.floor(editorCanvas.height / editorState.mapHeight);
        tileSize = Math.min(maxTileWidth, maxTileHeight, 60);
        
        renderEditor();
    }
    
    // Populate tile palette
    function populateTilePalette() {
        const palette = document.getElementById('tilePalette');
        if (!palette) return;
        
        palette.innerHTML = '';
        
        ALL_TILES.forEach(tile => {
            const tileBtn = document.createElement('div');
            tileBtn.className = 'tile-btn';
            tileBtn.dataset.tileId = tile.id;
            tileBtn.title = tile.name;
            
            tileBtn.innerHTML = `
                <div class="tile-icon" style="background-color: ${tile.color};"></div>
                <div class="tile-name">${tile.name}</div>
            `;
            
            tileBtn.onclick = function() {
                // Remove selection from all tiles
                document.querySelectorAll('.tile-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Select this tile
                this.classList.add('selected');
                
                // Update editor state
                selectTile(tile.id, tile.isEntity);
            };
            
            palette.appendChild(tileBtn);
        });
        
        // Select first tile
        const firstTile = palette.querySelector('.tile-btn');
        if (firstTile) {
            firstTile.classList.add('selected');
            selectTile(ALL_TILES[0].id, ALL_TILES[0].isEntity);
        }
    }
    
    // Select tile
    function selectTile(tileId, isEntity = false) {
        editorState.selectedTile = tileId;
    }
    
    // Set editor tool
    function setEditorTool(tool) {
        editorState.currentTool = tool;
        
        // Update UI
        document.querySelectorAll('.tool-btn-small').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const toolBtn = document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1));
        if (toolBtn) {
            toolBtn.classList.add('active');
        }
    }
    
    // Get canvas coordinates
    function getCanvasCoordinates(clientX, clientY) {
        const rect = editorCanvas.getBoundingClientRect();
        const x = Math.floor((clientX - rect.left) / tileSize);
        const y = Math.floor((clientY - rect.top) / tileSize);
        
        if (x >= 0 && x < editorState.mapWidth && y >= 0 && y < editorState.mapHeight) {
            return { x, y };
        }
        
        return null;
    }
    
    // Handle mouse down
    function handleMouseDown(e) {
        e.preventDefault();
        isDragging = true;
        const pos = getCanvasCoordinates(e.clientX, e.clientY);
        if (pos) {
            lastPos = pos;
            placeTile(pos.x, pos.y);
        }
    }
    
    // Handle mouse move
    function handleMouseMove(e) {
        if (!isDragging) return;
        
        const pos = getCanvasCoordinates(e.clientX, e.clientY);
        if (!pos || !lastPos) return;
        
        if (pos.x !== lastPos.x || pos.y !== lastPos.y) {
            placeTile(pos.x, pos.y);
            lastPos = pos;
        }
    }
    
    // Handle mouse up
    function handleMouseUp() {
        isDragging = false;
        lastPos = null;
    }
    
    // Handle touch start
    function handleTouchStart(e) {
        e.preventDefault();
        if (e.touches.length === 1) {
            isDragging = true;
            const touch = e.touches[0];
            const pos = getCanvasCoordinates(touch.clientX, touch.clientY);
            if (pos) {
                lastPos = pos;
                placeTile(pos.x, pos.y);
            }
        }
    }
    
    // Handle touch move
    function handleTouchMove(e) {
        if (!isDragging || e.touches.length !== 1) return;
        e.preventDefault();
        
        const touch = e.touches[0];
        const pos = getCanvasCoordinates(touch.clientX, touch.clientY);
        if (!pos || !lastPos) return;
        
        if (pos.x !== lastPos.x || pos.y !== lastPos.y) {
            placeTile(pos.x, pos.y);
            lastPos = pos;
        }
    }
    
    // Handle touch end
    function handleTouchEnd() {
        isDragging = false;
        lastPos = null;
    }
    
    // Place tile at position
    function placeTile(x, y) {
        if (x < 0 || x >= editorState.mapWidth || y < 0 || y >= editorState.mapHeight) return;
        
        const selected = editorState.selectedTile;
        
        // Handle tools
        if (editorState.currentTool === 'eraser') {
            eraseTile(x, y);
            return;
        } else if (editorState.currentTool === 'fill') {
            fillMap(selected);
            return;
        }
        
        // Handle entity placement
        if (typeof selected === 'string') {
            if (selected === 'player') {
                setPlayerStart(x, y);
                return;
            } else if (selected.startsWith('enemy_')) {
                const enemyType = selected.replace('enemy_', '').toUpperCase();
                addEnemy(x, y, enemyType);
                return;
            }
        }
        
        // Handle special tiles
        if (selected === TILE_TYPES.EXIT) {
            setExitPos(x, y);
        } else if (selected === TILE_TYPES.COIN) {
            addItem(x, y, 'coin');
        } else if (selected === TILE_TYPES.SCROLL) {
            addItem(x, y, 'scroll');
        } else if (selected === TILE_TYPES.MYSTERY_BOX) {
            addItem(x, y, 'mystery');
        } else {
            // Regular tile
            editorState.tiles[y][x] = selected;
        }
        
        renderEditor();
    }
    
    // Fill entire map with tile
    function fillMap(tileId) {
        for (let y = 0; y < editorState.mapHeight; y++) {
            for (let x = 0; x < editorState.mapWidth; x++) {
                editorState.tiles[y][x] = tileId;
            }
        }
        renderEditor();
    }
    
    // Erase tile
    function eraseTile(x, y) {
        editorState.tiles[y][x] = TILE_TYPES.FLOOR;
        removeEntityAt(x, y);
        renderEditor();
    }
    
    // Add enemy
    function addEnemy(x, y, type) {
        removeEntityAt(x, y);
        editorState.enemies.push({ x, y, type });
        renderEditor();
    }
    
    // Set player start
    function setPlayerStart(x, y) {
        removeEntityAt(x, y);
        editorState.playerStart = { x, y };
        renderEditor();
    }
    
    // Set exit position
    function setExitPos(x, y) {
        removeEntityAt(x, y);
        editorState.exitPos = { x, y };
        renderEditor();
    }
    
    // Add item
    function addItem(x, y, type) {
        removeEntityAt(x, y);
        editorState.items.push({ x, y, type });
        renderEditor();
    }
    
    // Remove entity at position
    function removeEntityAt(x, y) {
        editorState.enemies = editorState.enemies.filter(e => !(e.x === x && e.y === y));
        editorState.items = editorState.items.filter(item => !(item.x === x && item.y === y));
        
        if (editorState.playerStart && editorState.playerStart.x === x && editorState.playerStart.y === y) {
            editorState.playerStart = null;
        }
        if (editorState.exitPos && editorState.exitPos.x === x && editorState.exitPos.y === y) {
            editorState.exitPos = null;
        }
    }
    
    // Render editor
    function renderEditor() {
        if (!editorCtx || !editorCanvas) return;
        
        // Clear canvas
        editorCtx.fillStyle = '#111';
        editorCtx.fillRect(0, 0, editorCanvas.width, editorCanvas.height);
        
        const width = editorState.mapWidth;
        const height = editorState.mapHeight;
        
        // Draw tiles
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                drawTile(x, y, editorState.tiles[y][x]);
            }
        }
        
        // Draw grid
        drawGrid();
        
        // Draw entities
        editorState.enemies.forEach(enemy => drawEntity(enemy.x, enemy.y, enemy.type));
        editorState.items.forEach(item => drawEntity(item.x, item.y, item.type));
        if (editorState.playerStart) drawEntity(editorState.playerStart.x, editorState.playerStart.y, 'player');
        if (editorState.exitPos) drawEntity(editorState.exitPos.x, editorState.exitPos.y, 'exit');
    }
    
    // Draw a tile
    function drawTile(x, y, tileId) {
        const tile = ALL_TILES.find(t => t.id === tileId) || { color: '#ff00ff' };
        const tx = x * tileSize;
        const ty = y * tileSize;
        
        editorCtx.fillStyle = tile.color + '80';
        editorCtx.fillRect(tx, ty, tileSize, tileSize);
        
        editorCtx.strokeStyle = tile.color;
        editorCtx.lineWidth = 1;
        editorCtx.strokeRect(tx, ty, tileSize, tileSize);
    }
    
    // Draw an entity
    function drawEntity(x, y, type) {
        const tx = x * tileSize;
        const ty = y * tileSize;
        
        let color = '#fff';
        let symbol = '?';
        
        switch(type) {
            case 'player': color = '#00d2ff'; symbol = 'P'; break;
            case 'exit': color = '#0f0'; symbol = 'E'; break;
            case 'coin': color = '#ffd700'; symbol = 'C'; break;
            case 'scroll': color = '#9932cc'; symbol = 'S'; break;
            case 'mystery': color = '#ff9900'; symbol = '?'; break;
            case 'NORMAL': color = '#ff3333'; symbol = 'G'; break;
            case 'ARCHER': color = '#33cc33'; symbol = 'A'; break;
            case 'SPEAR': color = '#3366ff'; symbol = 'S'; break;
        }
        
        editorCtx.fillStyle = color + '40';
        editorCtx.fillRect(tx + 2, ty + 2, tileSize - 4, tileSize - 4);
        
        editorCtx.fillStyle = color;
        editorCtx.font = `bold ${tileSize/2}px Arial`;
        editorCtx.textAlign = 'center';
        editorCtx.textBaseline = 'middle';
        editorCtx.fillText(symbol, tx + tileSize/2, ty + tileSize/2);
    }
    
    // Draw grid
    function drawGrid() {
        editorCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        editorCtx.lineWidth = 1;
        
        for (let x = 0; x <= editorState.mapWidth; x++) {
            editorCtx.beginPath();
            editorCtx.moveTo(x * tileSize, 0);
            editorCtx.lineTo(x * tileSize, editorState.mapHeight * tileSize);
            editorCtx.stroke();
        }
        
        for (let y = 0; y <= editorState.mapHeight; y++) {
            editorCtx.beginPath();
            editorCtx.moveTo(0, y * tileSize);
            editorCtx.lineTo(editorState.mapWidth * tileSize, y * tileSize);
            editorCtx.stroke();
        }
    }
    
    // Clear map
    function editorClearMap() {
        if (confirm("Clear the entire map?")) {
            createEmptyMap();
            renderEditor();
        }
    }
    
    // Randomize walls
    function editorRandomizeWalls() {
        for (let y = 1; y < editorState.mapHeight - 1; y++) {
            for (let x = 1; x < editorState.mapWidth - 1; x++) {
                if (Math.random() < 0.3) {
                    editorState.tiles[y][x] = TILE_TYPES.WALL;
                } else {
                    editorState.tiles[y][x] = TILE_TYPES.FLOOR;
                }
            }
        }
        renderEditor();
    }
    
    // Resize map
    function editorResizeMap() {
        const widthInput = document.getElementById('mapWidthInput');
        const heightInput = document.getElementById('mapHeightInput');
        
        const newWidth = Math.min(20, Math.max(8, parseInt(widthInput.value) || 12));
        const newHeight = Math.min(20, Math.max(8, parseInt(heightInput.value) || 12));
        
        editorState.mapWidth = newWidth;
        editorState.mapHeight = newHeight;
        
        // Create new tiles array
        const newTiles = Array(newHeight).fill().map(() => Array(newWidth).fill(TILE_TYPES.FLOOR));
        
        // Copy old tiles
        for (let y = 0; y < Math.min(newHeight, editorState.tiles.length); y++) {
            for (let x = 0; x < Math.min(newWidth, editorState.tiles[0].length); x++) {
                newTiles[y][x] = editorState.tiles[y][x];
            }
        }
        
        editorState.tiles = newTiles;
        
        // Filter out of bounds entities
        editorState.enemies = editorState.enemies.filter(e => e.x < newWidth && e.y < newHeight);
        editorState.items = editorState.items.filter(item => item.x < newWidth && item.y < newHeight);
        
        if (editorState.playerStart && (editorState.playerStart.x >= newWidth || editorState.playerStart.y >= newHeight)) {
            editorState.playerStart = null;
        }
        if (editorState.exitPos && (editorState.exitPos.x >= newWidth || editorState.exitPos.y >= newHeight)) {
            editorState.exitPos = null;
        }
        
        editorAddBorderWalls();
        updateCanvasSize();
        renderEditor();
    }
    
    // Export mission JSON
    function editorExportMissionJSON() {
        // Get rules from checkboxes
        const rules = [];
        document.querySelectorAll('#rulesChecklist input:checked').forEach(cb => {
            rules.push(cb.value);
        });
        
        // Create mission data
        const missionData = {
            name: editorState.missionName,
            story: editorState.missionStory,
            goal: editorState.missionGoal,
            rules: rules,
            timeLimit: editorState.timeLimit,
            width: editorState.mapWidth,
            height: editorState.mapHeight,
            tiles: editorState.tiles,
            playerStart: editorState.playerStart,
            exit: editorState.exitPos,
            enemies: editorState.enemies,
            items: editorState.items,
            difficulty: "medium",
            createdAt: new Date().toISOString(),
            version: "1.0"
        };
        
        // Validate
        if (!missionData.playerStart) {
            alert("‚ö†Ô∏è Warning: No player start position set!");
        }
        if (!missionData.exit) {
            alert("‚ö†Ô∏è Warning: No exit position set!");
        }
        
        // Display JSON
        const jsonString = JSON.stringify(missionData, null, 2);
        const jsonOutput = document.getElementById('jsonOutput');
        if (jsonOutput) {
            jsonOutput.value = jsonString;
        }
        
        // Also show in alert for easy copying
        alert("Mission JSON exported! Check the textarea in the editor.");
    }
    
    // Import mission JSON
    function editorImportMissionJSON() {
        const jsonOutput = document.getElementById('jsonOutput');
        if (!jsonOutput || !jsonOutput.value) {
            alert("No JSON to import!");
            return;
        }
        
        try {
            const missionData = JSON.parse(jsonOutput.value);
            loadMissionData(missionData);
            alert("Mission imported successfully!");
        } catch (error) {
            alert("Error parsing JSON: " + error.message);
        }
    }
    
    // Load mission data into editor
    function loadMissionData(missionData) {
        console.log("Loading mission data into editor:", missionData);
        
        // Update editor state
        editorState.missionName = missionData.name || "New Mission";
        editorState.missionStory = missionData.story || "";
        editorState.missionGoal = missionData.goal || "escape";
        editorState.missionRules = missionData.rules || [];
        editorState.timeLimit = parseInt(missionData.timeLimit) || 20;
        editorState.mapWidth = missionData.width || 12;
        editorState.mapHeight = missionData.height || 12;
        
        // Update tiles
        if (missionData.tiles && Array.isArray(missionData.tiles)) {
            editorState.tiles = missionData.tiles;
        } else {
            editorState.tiles = Array(editorState.mapHeight).fill().map(() => 
                Array(editorState.mapWidth).fill(TILE_TYPES.FLOOR)
            );
        }
        
        // Update entities
        editorState.playerStart = missionData.playerStart || null;
        editorState.exitPos = missionData.exit || null;
        editorState.enemies = missionData.enemies || [];
        editorState.items = missionData.items || [];
        
        // Update form fields
        const nameInput = document.getElementById('missionNameInput');
        const storyInput = document.getElementById('missionStoryInput');
        const goalSelect = document.getElementById('missionGoalSelect');
        const timeLimitInput = document.getElementById('timeLimitInput');
        const widthInput = document.getElementById('mapWidthInput');
        const heightInput = document.getElementById('mapHeightInput');
        
        if (nameInput) nameInput.value = editorState.missionName;
        if (storyInput) storyInput.value = editorState.missionStory;
        if (goalSelect) goalSelect.value = editorState.missionGoal;
        if (timeLimitInput) timeLimitInput.value = editorState.timeLimit;
        if (widthInput) widthInput.value = editorState.mapWidth;
        if (heightInput) heightInput.value = editorState.mapHeight;
        
        // Update rules checkboxes
        if (missionData.rules) {
            document.querySelectorAll('#rulesChecklist input').forEach(cb => {
                cb.checked = missionData.rules.includes(cb.value);
            });
        }
        
        updateTimeLimitVisibility();
        updateCanvasSize();
        renderEditor();
        
        console.log("Mission loaded into editor!");
    }
    
    // Test mission
    function editorTestMission() {
        if (!editorState.playerStart) {
            alert("Cannot test: No player start position set");
            return;
        }
        if (!editorState.exitPos) {
            alert("Cannot test: No exit position set");
            return;
        }
        
        // Get rules from checkboxes
        const rules = [];
        document.querySelectorAll('#rulesChecklist input:checked').forEach(cb => {
            rules.push(cb.value);
        });
        
        // Create mission data
        const missionData = {
            name: editorState.missionName,
            story: editorState.missionStory,
            goal: editorState.missionGoal,
            rules: rules,
            timeLimit: editorState.timeLimit,
            width: editorState.mapWidth,
            height: editorState.mapHeight,
            tiles: editorState.tiles,
            playerStart: editorState.playerStart,
            exit: editorState.exitPos,
            enemies: editorState.enemies,
            items: editorState.items
        };
        
        // Hide editor
        document.getElementById('mapEditorScreen').classList.add('hidden');
        
        // Start the mission
        if (typeof startCustomMission === 'function') {
            startCustomMission(missionData);
        } else {
            alert("Game functions not available");
            document.getElementById('mapEditorScreen').classList.remove('hidden');
        }
    }
    
    // Save to localStorage
    function editorSaveToLocalStorage() {
        const missionData = {
            name: editorState.missionName,
            story: editorState.missionStory,
            goal: editorState.missionGoal,
            rules: editorState.missionRules,
            timeLimit: editorState.timeLimit,
            width: editorState.mapWidth,
            height: editorState.mapHeight,
            tiles: editorState.tiles,
            playerStart: editorState.playerStart,
            exit: editorState.exitPos,
            enemies: editorState.enemies,
            items: editorState.items
        };
        
        localStorage.setItem('stealthGame_editorDraft', JSON.stringify(missionData));
        alert("Draft saved to localStorage!");
    }
    
    // Load from localStorage
    function editorLoadFromLocalStorage() {
        const saved = localStorage.getItem('stealthGame_editorDraft');
        if (!saved) {
            alert("No saved draft found!");
            return;
        }
        
        try {
            const missionData = JSON.parse(saved);
            loadMissionData(missionData);
            alert("Draft loaded from localStorage!");
        } catch (error) {
            alert("Error loading draft: " + error.message);
        }
    }
    
    // Make functions globally available
    window.initMapEditor = initMapEditor;
    window.loadMissionData = loadMissionData;
    window.setEditorTool = setEditorTool;
    window.editorClearMap = editorClearMap;
    window.editorRandomizeWalls = editorRandomizeWalls;
    window.editorAddBorderWalls = editorAddBorderWalls;
    window.editorResizeMap = editorResizeMap;
    window.editorExportMissionJSON = editorExportMissionJSON;
    window.editorImportMissionJSON = editorImportMissionJSON;
    window.editorTestMission = editorTestMission;
    window.editorSaveToLocalStorage = editorSaveToLocalStorage;
    window.editorLoadFromLocalStorage = editorLoadFromLocalStorage;
    
    console.log("Map Editor script loaded!");
    </script>
    
</body>
</html>