<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Silent House</title>

<style>
body {
  margin:0;
  background:#111;
  color:#eee;
  font-family: monospace;
  text-align:center;
  touch-action:none;
  overscroll-behavior:none;
}
canvas {
  display:block;
  margin:0 auto;
  background:#222;
  border:2px solid #555;
}
button {
  padding:10px 16px;
  margin:5px;
  background:#333;
  color:#eee;
  border:1px solid #666;
}
.hidden { display:none; }
#controls button {
  width:60px;
  height:60px;
  font-size:22px;
}
#info { min-height:40px; }
</style>
</head>

<body>

<h2>Silent House</h2>

<div id="menu">
  <p>Turn-based ninja puzzle</p>
  <p>Level: <span id="levelText">1</span></p>
  <button onclick="changeLevel(-1)">−</button>
  <button onclick="changeLevel(1)">+</button><br><br>
  <button onclick="startGame()">START</button>
</div>

<canvas id="game" width="320" height="320" class="hidden"></canvas>

<div id="controls" class="hidden">
  <button onclick="movePlayer(0,-1)">↑</button><br>
  <button onclick="movePlayer(-1,0)">←</button>
  <button onclick="movePlayer(1,0)">→</button><br>
  <button onclick="movePlayer(0,1)">↓</button>
</div>

<p id="info"></p>
<button id="backBtn" class="hidden" onclick="backToMenu()">BACK</button>

<script>
/* ===== CONFIG ===== */
const SIZE = 10;
const TILE = 32;

/* ===== TILE TYPES ===== */
const FLOOR=0, WALL=1, NOISE=2, EXIT=3, HIDE=4;

/* ===== STATE ===== */
let levelNumber=1, grid, player, enemies, gameOver;
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

/* ===== MENU ===== */
function changeLevel(v){
  levelNumber=Math.max(1,levelNumber+v);
  levelText.textContent=levelNumber;
}
function startGame(){
  menu.classList.add("hidden");
  game.classList.remove("hidden");
  controls.classList.remove("hidden");
  backBtn.classList.remove("hidden");
  generateLevel();
}
function backToMenu(){
  menu.classList.remove("hidden");
  game.classList.add("hidden");
  controls.classList.add("hidden");
  backBtn.classList.add("hidden");
  info.textContent="";
}

/* ===== LEVEL GEN ===== */
function generateLevel(){
  gameOver=false;
  grid=Array.from({length:SIZE},(_,y)=>
    Array.from({length:SIZE},(_,x)=>
      (x===0||y===0||x===SIZE-1||y===SIZE-1)?WALL:
      Math.random()<0.15?WALL:FLOOR
    )
  );

  player={x:1,y:1,hidden:false};
  grid[SIZE-2][SIZE-2]=EXIT;

  for(let i=0;i<levelNumber+1;i++) placeRandom(NOISE);
  for(let i=0;i<Math.max(1,Math.floor(levelNumber/2));i++) placeRandom(HIDE);

  enemies=[];
  const count=Math.min(1+Math.floor(levelNumber/2),6);
  for(let i=0;i<count;i++) spawnEnemy();

  updateInfo(`Level ${levelNumber} • Enemies ${count}`);
  draw();
}

function placeRandom(type){
  let x,y;
  do{
    x=Math.floor(Math.random()*SIZE);
    y=Math.floor(Math.random()*SIZE);
  }while(grid[y][x]!==FLOOR||(x===1&&y===1));
  grid[y][x]=type;
}

function spawnEnemy(){
  let x,y;
  do{
    x=Math.floor(Math.random()*SIZE);
    y=Math.floor(Math.random()*SIZE);
  }while(grid[y][x]!==FLOOR);
  enemies.push({
    x,y,
    dir:[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}][Math.floor(Math.random()*4)],
    target:null
  });
}

/* ===== GAMEPLAY ===== */
function movePlayer(dx,dy){
  if(gameOver)return;
  const nx=player.x+dx, ny=player.y+dy;
  if(grid[ny][nx]===WALL)return;

  player.x=nx; player.y=ny;
  player.hidden=grid[ny][nx]===HIDE;

  if(grid[ny][nx]===NOISE){
    enemies.forEach(e=>e.target={x:nx,y:ny});
    updateInfo("Noise! Guards alerted");
  } else updateInfo("Moved");

  if(grid[ny][nx]===EXIT){
    updateInfo("Escaped!");
    gameOver=true;
    levelNumber++;
    setTimeout(startGame,1000);
    return;
  }
  enemyTurn();
}

function enemyTurn(){
  for(const e of enemies){
    if(!player.hidden && canSee(e)){
      updateInfo("You were seen!");
      gameOver=true;
      return;
    }
    if(e.target) step(e,e.target);
    else patrol(e);
  }
  draw();
}

function patrol(e){
  const nx=e.x+e.dir.x, ny=e.y+e.dir.y;
  if(grid[ny][nx]===WALL){
    e.dir.x*=-1; e.dir.y*=-1;
  } else { e.x=nx; e.y=ny; }
}

function step(e,t){
  if(e.x<t.x)e.x++;
  else if(e.x>t.x)e.x--;
  else if(e.y<t.y)e.y++;
  else if(e.y>t.y)e.y--;
  if(e.x===t.x&&e.y===t.y)e.target=null;
}

function canSee(e){
  const dx=player.x-e.x, dy=player.y-e.y;
  if(Math.abs(dx)+Math.abs(dy)>4)return false;
  if(dx!==0&&dy!==0)return false;
  const sx=Math.sign(dx), sy=Math.sign(dy);
  let x=e.x+sx, y=e.y+sy;
  while(x!==player.x||y!==player.y){
    if(grid[y][x]===WALL)return false;
    x+=sx; y+=sy;
  }
  return true;
}

/* ===== DRAW ===== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // tiles
  for(let y=0;y<SIZE;y++)for(let x=0;x<SIZE;x++){
    ctx.fillStyle=
      grid[y][x]===WALL?"#555":
      grid[y][x]===HIDE?"#000":
      grid[y][x]===NOISE?"#aa0":
      grid[y][x]===EXIT?"#0a0":"#222";
    ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
  }

  // move highlights
  [[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{
    const nx=player.x+d[0], ny=player.y+d[1];
    if(grid[ny][nx]!==WALL){
      ctx.fillStyle="rgba(0,150,255,0.3)";
      ctx.fillRect(nx*TILE,ny*TILE,TILE,TILE);
    }
  });

  // vision cones
  enemies.forEach(e=>{
    for(let i=1;i<=4;i++){
      const x=e.x+e.dir.x*i, y=e.y+e.dir.y*i;
      if(grid[y][x]===WALL)break;
      ctx.fillStyle="rgba(255,0,0,0.2)";
      ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
    }
  });

  // player
  ctx.fillStyle=player.hidden?"#00a":"#0af";
  ctx.fillRect(player.x*TILE+8,player.y*TILE+8,16,16);

  // enemies
  ctx.fillStyle="#f00";
  enemies.forEach(e=>{
    ctx.fillRect(e.x*TILE+8,e.y*TILE+8,16,16);
  });
}

function updateInfo(t){ info.textContent=t; }

/* ===== TOUCH ===== */
let sx=0, sy=0;
canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  sx=t.clientX; sy=t.clientY;
  e.preventDefault();
});
canvas.addEventListener("touchend",e=>{
  const t=e.changedTouches[0];
  const dx=t.clientX-sx, dy=t.clientY-sy;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>30)movePlayer(1,0);
    else if(dx<-30)movePlayer(-1,0);
  } else {
    if(dy>30)movePlayer(0,1);
    else if(dy<-30)movePlayer(0,-1);
  }
  e.preventDefault();
});
</script>

</body>
</html>